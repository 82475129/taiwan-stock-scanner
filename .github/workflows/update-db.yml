name: è‡ªå‹•æ›´æ–°è‚¡ç¥¨è³‡æ–™åº«

on:
  schedule:
    # æ¯å¤©å°ç£æ™‚é–“ 17:00 åŸ·è¡Œ (UTC 09:00)
    - cron: '0 9 * * *'
  push:
    branches: [ main ]
  workflow_dispatch: # å…è¨±ä½ éš¨æ™‚åœ¨ GitHub UI æ‰‹å‹•é»æ“ŠåŸ·è¡Œ

jobs:
  update-process:
    runs-on: ubuntu-latest
    # å¿…é ˆé–‹å•Ÿå¯«å…¥æ¬Šé™ï¼Œå¦å‰‡ push æœƒå ± 128 æˆ– 403 éŒ¯èª¤
    permissions:
      contents: write
      
    steps:
    - name: 1. æª¢å‡ºç¨‹å¼ç¢¼ (Checkout)
      uses: actions/checkout@v4
      with:
        # fetch-depth: 0 å°æ–¼å¾ŒçºŒçš„ git pull/rebase è‡³é—œé‡è¦
        fetch-depth: 0

    - name: 2. è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: 3. å®‰è£å¿…è¦å¥—ä»¶ (Pandas & Lxml)
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas lxml html5lib

    - name: 4. åŸ·è¡Œæ›´æ–°è…³æœ¬ (update_db.py)
      run: python update_db.py

    - name: 5. è™•ç† Git æäº¤èˆ‡æ¨é€ (è§£æ±º Exit Code 128)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # è¨­å®šæ©Ÿå™¨äººèº«åˆ†
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦æœ‰è®Šå‹•
        git add taiwan_full_market.json
        if [ -z "$(git status --porcelain)" ]; then
          echo "âœ… è³‡æ–™åº«å·²æ˜¯æœ€æ–°ï¼Œç„¡éœ€æ›´æ–°ã€‚"
          exit 0
        fi

        # æäº¤è®Šå‹•
        git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°æ¸…å–®: $(date +'%Y-%m-%d %H:%M')"
        
        # --- è§£æ±º 128 éŒ¯èª¤çš„æ ¸å¿ƒæ­¥é©Ÿ ---
        # ç¢ºä¿åœ¨æ¨é€å‰å…ˆæ‹‰å–é ç«¯æœ€æ–°è®Šå‹•ä¸¦é€²è¡Œé‡åŸº (Rebase)
        git pull --rebase origin main
        
        # æ¨é€å›ä¸»åˆ†æ”¯
        git push origin main
