name: è‡ªå‹•æ›´æ–°è‚¡ç¥¨è³‡æ–™åº«

on:
  schedule:
    - cron: '0 9 * * *' # å°ç£æ™‚é–“ 17:00
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  update-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: 1. æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 2. è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: 3. å®‰è£å¥—ä»¶
      # ç¢ºä¿å®‰è£ pandas æ‰€éœ€çš„è§£æå¼•æ“
      run: |
        pip install requests pandas lxml html5lib

    - name: 4. åŸ·è¡Œæ›´æ–°è…³æœ¬ (ç”Ÿæˆ JSON)
      # é€™è£¡æœƒè‡ªå‹•ç”Ÿæˆæ¶ˆå¤±çš„ taiwan_full_market.json
      run: python update_db.py

    - name: 5. æª¢æŸ¥ä¸¦æäº¤æ›´æ–°
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # ã€é—œéµä¿®æ­£ã€‘å…ˆæª¢æŸ¥æª”æ¡ˆåˆ°åº•æœ‰æ²’æœ‰ç”Ÿå‡ºä¾†
        if [ ! -f "taiwan_full_market.json" ]; then
          echo "âŒ éŒ¯èª¤ï¼šupdate_db.py æœªèƒ½ç”Ÿæˆ taiwan_full_market.jsonï¼Œè«‹æª¢æŸ¥è…³æœ¬å…§å®¹ã€‚"
          exit 1
        fi

        git add taiwan_full_market.json
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´ï¼ˆåŒ…å«æ–°æª”æ¡ˆï¼‰
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "ğŸ¤– è‡ªå‹•é‡å»ºä¸¦æ›´æ–°å…¨å¸‚å ´æ¸…å–®: $(date +'%Y-%m-%d %H:%M')"
          git pull --rebase origin main
          git push origin main
        else
          echo "âœ… è³‡æ–™ç„¡è®Šå‹•ï¼Œè·³éæ›´æ–°ã€‚"
        fi
