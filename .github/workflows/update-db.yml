name: è‡ªå‹•æ›´æ–°è‚¡ç¥¨è³‡æ–™åº«

on:
  schedule:
    - cron: '0 9 * * *' # UTC 09:00 = å°ç£æ™‚é–“ 17:00
  push:
    branches: [ main ]
  workflow_dispatch: # å…è¨±æ‰‹å‹•é»æ“ŠåŸ·è¡Œ

jobs:
  update-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip' # é–‹å•Ÿå¿«å–åŠ é€Ÿå®‰è£

    - name: å®‰è£å¿…è¦å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas lxml html5lib
        # å¦‚æœä½ çš„ update_db.py é‚„æ˜¯ç”¨èˆŠç‰ˆ BeautifulSoupï¼Œå°±è£œä¸Š beautifulsoup4
        # pip install beautifulsoup4 

    - name: åŸ·è¡Œæ›´æ–°é»¨å“¡ (update_db.py)
      run: python update_db.py

    - name: æäº¤èˆ‡æ¨é€è®Šæ›´
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # å…ˆæ‹‰å–é ç«¯è®Šæ›´ï¼Œé˜²æ­¢è¡çª
        git pull origin main
        
        # æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆè®Šæ›´ï¼Œæœ‰è®Šæ›´æ‰ commit
        git add taiwan_full_market.json
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°å…¨å¸‚å ´æ¸…å–®: $(date +'%Y-%m-%d %H:%M')"
          git push
        else
          echo "è³‡æ–™ç„¡è®Šå‹•ï¼Œè·³éæäº¤ã€‚"
        fi
